{% extends model('component') %}

{% define config = {
    name: 'cart-comments',
    tag: 'cart-comments',
} %}

{% define data = {
    ownerId: required,
    ownerType: required,
    returnRoute: required,
    commentThread: required,
    createCommentForm: required,
    allCommentForms: required,
    attachCommentForms: required,
} %}

{% define attributes = {
    'tab-selector': required,
    'content-block-selector': required,
    'tab-class-to-toggle': required,
    'content-block-class-to-toggle': required,
} %}

{% set attachedComments = [] %}

{% for comment in data.commentThread.comments %}
    {% if comment.isAttached %}
        {% set attachedComments = attachedComments|merge([comment]) %}
    {% endif %}
{% endfor %}

{% block body %}
    <div class="{{config.name}}__container">
        {% block tabs %}
            <ul class="{{config.name}}__tabs">
                <li class="{{config.name}}__tab">
                    <button class="{{config.name}}__action {{config.name}}__action--active {{config.jsName}}__tab"> {{ 'comment_widget.form.all' | trans }} ({{ data.commentThread.comments|length }})</button>
                </li>
                <li class="{{config.name}}__tab">
                    <button class="{{config.name}}__action {{config.jsName}}__tab">{{ 'comment_widget.form.attached' | trans }} ({{ attachedComments|length }}) </button>
                </li>
            </ul>
        {% endblock %}
        {% block content %}
            <div class="{{config.name}}__content">
                <div class="{{config.name}}__content-item {{config.name}}__content-item--active {{config.jsName}}__content-item">
                    {% for comment in data.commentThread.comments %}
                        <div class="{{config.name}}--info">
                            {% if data.allCommentForms[comment.idComment] is defined %}

                                {% set form = data.allCommentForms[comment.idComment] %}

                                {% include molecule('cart-comment-form', 'CommentWidget') with {
                                    data: {
                                        form: form,
                                        comment: comment,
                                        returnRoute: data.returnRoute,
                                    },
                                } only %}
                            {% else %}
                                {% include molecule('cart-comment-info', 'CommentWidget') with {
                                    data: {
                                        comment: comment,
                                    },
                                } only %}
                            {% endif %}

                            {% include molecule('cart-comment-action-form', 'CommentWidget') with {
                                data: {
                                    action: url(comment.isAttached ? 'comment/tag/unattach' : 'comment/tag/attach'),
                                    hiddenData: [
                                        {
                                            name:"uuid",
                                            value: comment.uuid,
                                        },
                                        {
                                            name:"returnRoute",
                                            value: data.returnRoute,
                                        }
                                    ],
                                    buttonClassString: 'button button--warning',
                                    buttonText: comment.isAttached ? ('comment_widget.form.unattach' | trans) : ('comment_widget.form.attach' | trans),
                                },
                            } only %}
                        </div>
                    {% endfor %}
                    <hr>
                </div>
                <div class="{{config.name}}__content-item {{config.jsName}}__content-item">
                    {% if data.commentThread %}
                        {% for comment in data.commentThread.comments %}
                            <div class="{{config.name}}--info">
                                {% if comment.isAttached %}
                                    {% if data.attachCommentForms[comment.idComment] is defined %}
                                        {% set form = data.attachCommentForms[comment.idComment] %}

                                        {% include molecule('cart-comment-form', 'CommentWidget') with {
                                            data: {
                                                form: form,
                                                comment: comment,
                                                returnRoute: data.returnRoute,
                                            },
                                        } only %}
                                    {% else %}
                                        {% include molecule('cart-comment-info', 'CommentWidget') with {
                                            data: {
                                                comment: comment,
                                            },
                                        } only %}
                                    {% endif %}

                                    {% include molecule('cart-comment-action-form', 'CommentWidget') with {
                                        data: {
                                            action: url(comment.isAttached ? 'comment/tag/unattach' : 'comment/tag/attach'),
                                            hiddenData: [
                                                {
                                                    name:"uuid",
                                                    value: comment.uuid,
                                                },
                                                {
                                                    name:"returnRoute",
                                                    value: data.returnRoute,
                                                }
                                            ],
                                            buttonClassString: 'button button--warning',
                                            buttonText: comment.isAttached ? ('comment_widget.form.unattach' | trans) : ('comment_widget.form.attach' | trans),
                                        },
                                    } only %}
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        {% endblock %}
    </div>
{% endblock %}
